Wildcard certs

Create individual node
	-Configure TLS toolkit
		-Configure client cert
	-Copy keystore/truststore/nifi.properties
	-Configure zookeeper properties
	-Configure IAI user


	/etc/hosts aliases
	different ports?

	docker cluster
	same ports mapped to different host port

	wildcart cert same keystore, truststore, passwords for each node
	only port, hostname, different? (actual port in nifi.properties same, docker host port different)
	zookeeper settings?

	custom Dockerfile which reads ZK file from host?
	built on apache/nifi:latest


	manual configuration first

	cluster port 1(n)888
	s2s port 1(n)000
	api port 1(n)443
	zk port 218(n)

	Node 1

	

	Node 2

	

	Node 3



tar --exclude='bin/' \
--exclude='database_repository/' \
--exclude='content_repository/' \
--exclude='docs/' \
--exclude='flowfile_repository/' \
--exclude='lib/' \
--exclude='logs/' \
--exclude='provenance_repository/' \
--exclude='run/' \
--exclude='work/' \
--exclude="LICENSE" \
--exclude="NOTICE" \
--exclude="README" \
-zvcf archived_config.tar.gz .


Change election wait time to 10 seconds
Silent observer in election? (null participant ID in #register())
Still able to reproduce cert error

Built new lib and copied to all nodes



2018-07-06 21:19:15,721 WARN [Process Cluster Protocol Request-5] o.a.n.c.p.impl.SocketProtocolListener Failed processing protocol message from localhost due to org.apache.nifi.cluster.protocol.ProtocolException: java.security.cert.CertificateException: javax.net.ssl.SSLPeerUnverifiedException: peer not authenticated
org.apache.nifi.cluster.protocol.ProtocolException: java.security.cert.CertificateException: javax.net.ssl.SSLPeerUnverifiedException: peer not authenticated
	at org.apache.nifi.cluster.protocol.impl.SocketProtocolListener.getRequestorDN(SocketProtocolListener.java:225)
	at org.apache.nifi.cluster.protocol.impl.SocketProtocolListener.dispatchRequest(SocketProtocolListener.java:131)
	at org.apache.nifi.io.socket.SocketListener$2$1.run(SocketListener.java:136)
	at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1142)
	at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:617)
	at java.lang.Thread.run(Thread.java:745)
Caused by: java.security.cert.CertificateException: javax.net.ssl.SSLPeerUnverifiedException: peer not authenticated
	at org.apache.nifi.security.util.CertificateUtils.extractPeerDNFromClientSSLSocket(CertificateUtils.java:314)
	at org.apache.nifi.security.util.CertificateUtils.extractPeerDNFromSSLSocket(CertificateUtils.java:269)
	at org.apache.nifi.cluster.protocol.impl.SocketProtocolListener.getRequestorDN(SocketProtocolListener.java:223)
	... 5 common frames omitted
Caused by: javax.net.ssl.SSLPeerUnverifiedException: peer not authenticated
	at sun.security.ssl.SSLSessionImpl.getPeerCertificates(SSLSessionImpl.java:431)
	at org.apache.nifi.security.util.CertificateUtils.extractPeerDNFromClientSSLSocket(CertificateUtils.java:299)
	... 7 common frames omitted

Initial problem solved by using DefaultHostnameVerifier in ThreadPoolRequestReplicatorFactoryBean
Some other cluster comms are not sending peer certs with clientAuth=NEED
Unverified proxy with wildcard
SocketTimeout



ðŸ”“ 0s @ 18:07:58 $ tree -L 2
.
â”œâ”€â”€ certs
â”œâ”€â”€ hardcoded
â”‚Â Â  â”œâ”€â”€ CN=alopresto.NIFI-5370_OU=NiFi.p12
â”‚Â Â  â”œâ”€â”€ CN=alopresto.NIFI-5370_OU=NiFi.password
â”‚Â Â  â”œâ”€â”€ nifi-cert.pem
â”‚Â Â  â”œâ”€â”€ nifi-key.key
â”‚Â Â  â”œâ”€â”€ node1.nifi.apache.org
â”‚Â Â  â”œâ”€â”€ node2.nifi.apache.org
â”‚Â Â  â””â”€â”€ node3.nifi.apache.org
â”œâ”€â”€ node1
â”‚Â Â  â”œâ”€â”€ LICENSE
â”‚Â Â  â”œâ”€â”€ NOTICE
â”‚Â Â  â”œâ”€â”€ README
â”‚Â Â  â”œâ”€â”€ bin
â”‚Â Â  â”œâ”€â”€ conf
â”‚Â Â  â”œâ”€â”€ docs
â”‚Â Â  â””â”€â”€ lib
â”œâ”€â”€ node2
â”‚Â Â  â”œâ”€â”€ LICENSE
â”‚Â Â  â”œâ”€â”€ NOTICE
â”‚Â Â  â”œâ”€â”€ README
â”‚Â Â  â”œâ”€â”€ bin
â”‚Â Â  â”œâ”€â”€ conf
â”‚Â Â  â”œâ”€â”€ docs
â”‚Â Â  â””â”€â”€ lib
â”œâ”€â”€ node3
â”‚Â Â  â”œâ”€â”€ LICENSE
â”‚Â Â  â”œâ”€â”€ NOTICE
â”‚Â Â  â”œâ”€â”€ README
â”‚Â Â  â”œâ”€â”€ bin
â”‚Â Â  â”œâ”€â”€ conf
â”‚Â Â  â”œâ”€â”€ docs
â”‚Â Â  â””â”€â”€ lib
â””â”€â”€ wildcard
    â”œâ”€â”€ CN=alopresto.NIFI-5370_OU=NiFi.p12
    â”œâ”€â”€ CN=alopresto.NIFI-5370_OU=NiFi.password
    â”œâ”€â”€ nifi-cert.pem
    â”œâ”€â”€ nifi-key.key
    â””â”€â”€ star.nifi.apache.org

22 directories, 17 files